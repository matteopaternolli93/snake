<!DOCTYPE html>
<html>

<head>
  <title>Snake</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    /* Stile generale - Dark Mode con tocchi soft */
    body {
      background-color: #1f1f1f;
      color: #f0f0f0;
      font-family: 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden; /* Nascondi la scrollbar del browser */
    }

    /* Contenitore del gioco */
    #game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #282828;
      border-radius: 16px;
      overflow: hidden;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* Area di gioco */
    canvas {
      background-color: #1f1f1f;
      border: 4px solid #48484a;
      border-radius: 8px;
      touch-action: none; /* Disabilita lo scroll del browser */
    }

    /* Schermata di game over */
    #game-over {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 10;
      color: #ffffff;
      font-family: 'Helvetica Neue', sans-serif;
    }

    #game-over h2 {
      font-size: 36px;
      margin-bottom: 20px;
    }

    #restart-button {
      background-color: #0a84ff;
      color: #ffffff;
      border: none;
      padding: 14px 28px;
      font-size: 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #restart-button:hover {
      background-color: #007bff;
    }

    /* Schermata iniziale */
    #start-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 10;
      color: #ffffff;
      font-family: 'Helvetica Neue', sans-serif;
    }

    #start-screen h1 {
      font-size: 48px;
      margin-bottom: 20px;
    }

    #start-button {
      background-color: #0a84ff;
      color: #ffffff;
      border: none;
      padding: 14px 28px;
      font-size: 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #start-button:hover {
      background-color: #007bff;
    }
  </style>
</head>

<body>
  <div id="game-container">
    <canvas id="game-canvas"></canvas>
  </div>

  <div id="game-over">
    <h2>Game Over!</h2>
    <button id="restart-button">Gioca ancora</button>
  </div>

  <div id="start-screen">
    <h1>Snake</h1>
    <button id="start-button">Gioca</button>
  </div>

  <script>
    // Costanti per le dimensioni del gioco
    const GRID_SIZE = 70; // Aumenta la dimensione delle celle
    const SNAKE_SIZE = GRID_SIZE * 0.8; // Snake occupa l'80% della cella
    const FOOD_SIZE = GRID_SIZE * 0.9; // Cibo occupa il 90% della cella

    // Velocità di gioco
    const GAME_SPEED = 100;

    // Soglia per il movimento del touch
    const TOUCH_THRESHOLD = 10;

    // Elementi del DOM
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const gameOverScreen = document.getElementById('game-over');
    const restartButton = document.getElementById('restart-button');
    const startScreen = document.getElementById('start-screen');
    const startButton = document.getElementById('start-button');

    // Stato del gioco
    let game = {
      snake: [{ x: 10, y: 10 }], // Posizione iniziale del serpente
      food: {}, // Posizione del cibo
      direction: 'right', // Direzione iniziale del serpente
      gameOver: false, // Stato del gioco (true se è terminato)
      gameOverDisplayed: false // Flag per visualizzare la schermata di game over solo una volta
    };

    // Funzioni per il gioco

    // Resize della canvas in base alla dimensione della finestra
    function resizeCanvas() {
      // Calcola il numero di celle che possono stare nella finestra
      const gridWidth = Math.floor(window.innerWidth / GRID_SIZE);
      const gridHeight = Math.floor(window.innerHeight / GRID_SIZE);

      // Imposta le dimensioni della canvas
      canvas.width = gridWidth * GRID_SIZE;
      canvas.height = gridHeight * GRID_SIZE;

      // Assicurarsi che lo snake sia posizionato all'interno della canvas
      if (game.snake[0].x >= gridWidth) {
        game.snake[0].x = gridWidth - 1;
      }
      if (game.snake[0].y >= gridHeight) {
        game.snake[0].y = gridHeight - 1;
      }
    }

    // Controlla se la posizione del cibo è valida (non sulla testa del serpente)
    function isFoodPositionValid(x, y) {
      for (let i = 0; i < game.snake.length; i++) {
        if (game.snake[i].x === x && game.snake[i].y === y) {
          return false;
        }
      }
      return true;
    }

    // Genera una nuova posizione per il cibo in modo casuale
    function generateFood() {
      let x, y;
      do {
        x = Math.floor(Math.random() * (canvas.width / GRID_SIZE));
        y = Math.floor(Math.random() * (canvas.height / GRID_SIZE));
      } while (!isFoodPositionValid(x, y));
      game.food = { x, y };
    }

    // Disegna il serpente sulla canvas
    function drawSnake() {
      ctx.fillStyle = '#0a84ff'; // Colore del serpente
      for (let i = 0; i < game.snake.length; i++) {
        const x = game.snake[i].x * GRID_SIZE + (GRID_SIZE - SNAKE_SIZE) / 2;
        const y = game.snake[i].y * GRID_SIZE + (GRID_SIZE - SNAKE_SIZE) / 2;
        ctx.fillRect(x, y, SNAKE_SIZE, SNAKE_SIZE);
      }
    }

    // Disegna il cibo sulla canvas
    function drawFood() {
      ctx.fillStyle = '#ff3b30'; // Colore del cibo
      const x = game.food.x * GRID_SIZE + (GRID_SIZE - FOOD_SIZE) / 2;
      const y = game.food.y * GRID_SIZE + (GRID_SIZE - FOOD_SIZE) / 2;
      ctx.fillRect(x, y, FOOD_SIZE, FOOD_SIZE);
    }

    // Disegna tutto sulla canvas
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Pulisci la canvas
      drawSnake();
      drawFood();
    }

    // Sposta il serpente in base alla direzione
    function moveSnake() {
      const head = { x: game.snake[0].x, y: game.snake[0].y }; // Copia la testa del serpente

      // Aggiorna la posizione della testa in base alla direzione
      switch (game.direction) {
        case 'up':
          head.y--;
          break;
        case 'down':
          head.y++;
          break;
        case 'left':
          head.x--;
          break;
        case 'right':
          head.x++;
          break;
      }

      // Controlla le collisioni con se stesso PRIMA di spostare la testa
      for (let i = 1; i < game.snake.length; i++) {
        if (head.x === game.snake[i].x && head.y === game.snake[i].y) {
          game.gameOver = true;
          return; // Esci dalla funzione se c'è una collisione
        }
      }

      // Effetto Pac-Man: il serpente attraversa i bordi
      if (head.x < 0) head.x = canvas.width / GRID_SIZE - 1;
      if (head.x >= canvas.width / GRID_SIZE) head.x = 0;
      if (head.y < 0) head.y = canvas.height / GRID_SIZE - 1;
      if (head.y >= canvas.height / GRID_SIZE) head.y = 0;

      // Controlla se il serpente ha mangiato il cibo DOPO averlo spostato
      if (head.x === game.food.x && head.y === game.food.y) {
        generateFood(); // Genera nuovo cibo SOLO quando mangiato
      } else {
        game.snake.pop(); // Rimuovi la coda del serpente se non ha mangiato
      }

      // Aggiungi la nuova testa
      game.snake.unshift(head);
    }

    // Gestisce gli eventi touch per il controllo del serpente
    function handleTouchStart(e) {
      const touches = e.touches;
      let startX, startY;

      // Memorizza la posizione iniziale del tocco
      for (let i = 0; i < touches.length; i++) {
        const touch = touches[i];
        startX = touch.clientX;
        startY = touch.clientY;
      }

      // Gestisce il movimento del tocco
      function handleTouchMove(e) {
        const touch = e.touches[0]; // Presumo che ci sia solo un tocco rilevante
        const deltaX = touch.clientX - startX;
        const deltaY = touch.clientY - startY;

        // Controlla la direzione del movimento
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > TOUCH_THRESHOLD) {
          if (deltaX > 0 && game.direction !== 'left') game.direction = 'right';
          else if (deltaX < 0 && game.direction !== 'right') game.direction = 'left';
        } else if (Math.abs(deltaY) > TOUCH_THRESHOLD) {
          if (deltaY > 0 && game.direction !== 'up') game.direction = 'down';
          else if (deltaY < 0 && game.direction !== 'down') game.direction = 'up';
        }
        e.preventDefault(); // Impedisci lo scroll del browser
      }

      // Aggiunge gli event listener per il movimento e la fine del tocco
      canvas.addEventListener('touchmove', handleTouchMove);
      canvas.addEventListener('touchend', handleTouchEnd);

      function handleTouchEnd() {
        canvas.removeEventListener('touchmove', handleTouchMove);
        canvas.removeEventListener('touchend', handleTouchEnd);
      }
    }

    // Rilancio del ciclo di gioco
    function restartGameLoop() {
      let lastTime = 0;

      function gameLoop(timestamp) {
        if (!game.gameOver) {
          const deltaTime = timestamp - lastTime;
          // Sposta e disegna il serpente solo quando è passato un tempo sufficiente
          if (deltaTime >= GAME_SPEED) {
            moveSnake();
            draw();
            lastTime = timestamp;
          }
          requestAnimationFrame(gameLoop); // Chiama di nuovo il ciclo di gioco
        } else {
          // Visualizza la schermata di game over solo una volta
          if (!game.gameOverDisplayed) {
            gameOverScreen.style.display = 'flex';
            game.gameOverDisplayed = true;
          }
        }
      }

      // Avvia il ciclo di gioco per la prima volta
      requestAnimationFrame(gameLoop);
    }

    // Ripristina il gioco alla condizione iniziale
    function restartGame() {
      // Reinizializza il gioco
      game = {
        snake: [{ x: 10, y: 10 }],
        food: {},
        direction: 'right',
        gameOver: false,
        gameOverDisplayed: false
      };
      // Nascondi la schermata di game over
      gameOverScreen.style.display = 'none';
      // Aggiunge l'event listener per gli eventi touch
      canvas.addEventListener('touchstart', handleTouchStart);
      // Genera un nuovo cibo
      generateFood();
      // Avvia il ciclo di gioco
      restartGameLoop();
    }

    // Inizia il gioco
    function startGame() {
      // Nascondi la schermata iniziale
      startScreen.style.display = 'none';
      // Ridimensiona la canvas
      resizeCanvas();
      // Genera un nuovo cibo
      generateFood();
      // Avvia il ciclo di gioco
      restartGameLoop();
      // Aggiunge l'event listener per gli eventi touch
      canvas.addEventListener('touchstart', handleTouchStart);
    }

    // Inizializza il gioco
    function init() {
      // Aggiunge gli event listener per i pulsanti di restart e start
      restartButton.addEventListener('click', restartGame);
      startButton.addEventListener('click', startGame);
      // Aggiunge l'event listener per il resize della finestra
      window.addEventListener('resize', resizeCanvas);
    }

    // Avvia l'inizializzazione del gioco
    init();
  </script>
</body>

</html>